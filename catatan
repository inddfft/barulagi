<?php
// ===== Fungsi Load & Save =====
function loadData() {
    if (!file_exists("data/keuangan.json")) {
        return [];
    }
    return json_decode(file_get_contents("data/keuangan.json"), true);
}

function saveData($data) {
    file_put_contents("data/keuangan.json", json_encode($data, JSON_PRETTY_PRINT));
}

// ===== Ambil Data =====
$data = loadData();

// ===== Tambah Data =====
if (isset($_POST['aksi']) && $_POST['aksi'] == "tambah") {
    $data[] = [
        "tanggal" => $_POST['tanggal'],
        "keterangan" => $_POST['keterangan'],
        "kategori" => $_POST['kategori'],
        "tipe" => $_POST['tipe'],
        "jumlah" => floatval($_POST['jumlah'])
    ];
    saveData($data);
    header("Location: catatan.php");
    exit;
}

// ===== Hapus Data =====
if (isset($_GET['hapus'])) {
    unset($data[$_GET['hapus']]);
    $data = array_values($data);
    saveData($data);
    header("Location: catatan.php");
    exit;
}

// ===== Hitung Ringkasan =====
$pemasukan = 0;
$pengeluaran = 0;
foreach ($data as $d) {
    if ($d['tipe'] == "pemasukan") $pemasukan += $d['jumlah'];
    else $pengeluaran += $d['jumlah'];
}
$saldo = $pemasukan - $pengeluaran;

// ===== HTML =====
?>
<!DOCTYPE html>
<html>
<head>
    <title>Catatan Keuangan</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f8f9fa; }
        .box { background: white; padding:20px; border-radius:8px; max-width:900px; margin:auto; }
        table { width:100%; border-collapse:collapse; margin-top:15px; }
        th,td { padding:8px; border-bottom:1px solid #ddd; }
        th { background:#eee; }
        input,select { padding:8px; margin:3px; }
        .btn { padding:6px 10px; border:none; border-radius:4px; cursor:pointer; }
        .primary { background:#4f46e5; color:white; }
        .danger { background:#ef4444; color:white; }
    </style>
</head>
<body>

<div class="box">
    <h2>Catatan Keuangan (1 File)</h2>

    <!-- Form Tambah -->
    <form method="post">
        <input type="hidden" name="aksi" value="tambah">
        <input type="date" name="tanggal" required>
        <input type="text" name="keterangan" placeholder="Keterangan" required>
        <input type="text" name="kategori" placeholder="Kategori" required>
        <select name="tipe">
            <option value="pemasukan">Pemasukan</option>
            <option value="pengeluaran">Pengeluaran</option>
        </select>
        <input type="number" name="jumlah" placeholder="Jumlah" required>
        <button class="btn primary">Tambah</button>
    </form>

    <!-- Ringkasan -->
    <p><b>Pemasukan:</b> Rp <?= number_format($pemasukan) ?>
       | <b>Pengeluaran:</b> Rp <?= number_format($pengeluaran) ?>
       | <b>Saldo:</b> Rp <?= number_format($saldo) ?></p>

    <!-- Tabel Data -->
    <table>
        <tr>
            <th>#</th>
            <th>Tanggal</th>
            <th>Keterangan</th>
            <th>Kategori</th>
            <th>Tipe</th>
            <th>Jumlah</th>
            <th>Aksi</th>
        </tr>

        <?php if (count($data) == 0): ?>
        <tr><td colspan="7">Belum ada data.</td></tr>
        <?php endif; ?>

        <?php foreach ($data as $i => $row): ?>
        <tr>
            <td><?= $i+1 ?></td>
            <td><?= $row['tanggal'] ?></td>
            <td><?= $row['keterangan'] ?></td>
            <td><?= $row['kategori'] ?></td>
            <td><?= $row['tipe'] ?></td>
            <td>Rp <?= number_format($row['jumlah']) ?></td>
            <td>
                <a class="btn danger" href="catatan.php?hapus=<?= $i ?>" onclick="return confirm('Hapus data?')">Hapus</a>
            </td>
        </tr>
        <?php endforeach; ?>

    </table>
</div>

</body>
</html>
